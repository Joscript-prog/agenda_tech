<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agenda des interventions + Planification Techniciens</title>
  <style>
    :root{ --bg:#0b0f14; --panel:#111823; --muted:#7a8aa1; --text:#e6edf6; --accent:#4cc2ff; --accent-2:#78e08f; --danger:#ff6b6b; --warn:#ffc048; --radius:16px }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0a0f14,#0d141d);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    header{position:sticky;top:0;z-index:10;background:rgba(10,15,20,.8);backdrop-filter:saturate(140%) blur(10px);border-bottom:1px solid #17202e}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .brand{display:flex;gap:10px;align-items:center}
    .brand h1{font-size:18px;margin:0;font-weight:700;letter-spacing:.2px}
    .brand .dot{width:12px;height:12px;border-radius:50%;background:radial-gradient(circle at 30% 30%, #8ee0ff, #4cc2ff)}
    .toolbar{display:grid;grid-template-columns:1fr auto;gap:12px;margin-top:12px}
    .filters{display:flex;flex-wrap:wrap;gap:8px}
    .filters>*{min-width:150px}
    .actions{display:flex;flex-wrap:wrap;gap:8px}
    button,select,input[type="date"],input[type="time"],input[type="text"],input[type="file"],.btn,textarea{background:#0f1622;color:var(--text);border:1px solid #1d2a3c;border-radius:12px;padding:10px 12px;outline:none}
    button:hover,.btn:hover{border-color:#2b3d57}
    button.primary{background:linear-gradient(180deg,#1b283c,#142035);border-color:#274160}
    button.ok{background:linear-gradient(180deg,#204231,#1a3527);border-color:#2d6444}
    button.warn{background:linear-gradient(180deg,#3e310d,#2b2109);border-color:#6b5017}
    button.danger{background:linear-gradient(180deg,#3d1515,#2a0e0e);border-color:#6a2323}
    main{max-width:1200px;margin:18px auto;padding:0 16px 80px}
    .cards{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:860px){.cards{grid-template-columns:1fr 1fr}}
    .card{background:linear-gradient(180deg,#0f1622,#0c121b);border:1px solid #1a2535;border-radius:var(--radius);padding:16px;box-shadow:0 4px 18px rgba(0,0,0,.25)}
    .card h2{margin:0 0 12px 0;font-size:16px}
    .pill{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:6px 10px;border:1px solid #203049;background:#0f1622;color:#bcd}
    .list{width:100%;border-collapse:separate;border-spacing:0 8px}
    .list th{font-weight:600;color:#9fbed6;text-align:left;padding:4px 8px}
    .list td{background:#0f1622;border:1px solid #1b2940;border-left:none;border-right:none;padding:10px 10px}
    .list tr{transition:transform .08s ease}
    .list tr:hover{transform:translateY(-1px)}
    .list .row{border-radius:10px;overflow:hidden}
    .list .row td:first-child{border-left:1px solid #1b2940;border-top-left-radius:10px;border-bottom-left-radius:10px}
    .list .row td:last-child{border-right:1px solid #1b2940;border-top-right-radius:10px;border-bottom-right-radius:10px}
    .muted{color:var(--muted)}
    .badge{padding:2px 8px;border-radius:999px;border:1px solid #274160;background:#0f1622;font-size:12px}
    .badge.infra{border-color:#305f44}
    .badge.rocade{border-color:#604a30}
    .badge.audit{border-color:#2e4f7a}
    .tag{font-size:11px;padding:2px 6px;border-radius:6px;border:1px solid #2b3d57;color:#a9c2db}
    .tag.hno{border-color:#6b3e3e;color:#ffbdbd}
    .flex{display:flex;gap:8px;align-items:center}
    .right{margin-left:auto}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    dialog{border:none;border-radius:18px;background:linear-gradient(180deg,#0e1520,#0a121a);color:var(--text);padding:0;max-width:760px;box-shadow:0 20px 60px rgba(0,0,0,.45)}
    dialog::backdrop{background:rgba(2,6,12,.6)}
    .modal-head{padding:16px 18px;border-bottom:1px solid #1a2535;display:flex;gap:8px;align-items:center}
    .modal-body{padding:18px}
    .modal-foot{padding:12px 18px;border-top:1px solid #1a2535;display:flex;gap:8px;justify-content:flex-end}
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-size:12px;color:#a9c2db}
    .hint{font-size:12px;color:#9cb1c9}
    .sep{height:1px;background:#162133;margin:10px 0}
    .toast{position:fixed;right:14px;bottom:14px;background:#0f1622;color:#dfefff;border:1px solid #263652;border-radius:12px;padding:10px 12px;box-shadow:0 10px 30px rgba(0,0,0,.3)}
    .small{padding:6px 8px;border-radius:10px}
    .tablink{padding:8px 10px;border:1px solid #203049;border-radius:999px;cursor:pointer}
    .tablink.active{border-color:#2b6f45;background:linear-gradient(180deg,#1d3c2a,#13271c)}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="brand">
        <span class="dot"></span><h1>Agenda des interventions</h1>
        <span id="liveState" class="pill" title="√âtat de la connexion Realtime">Realtime : <strong id="liveLabel">off</strong></span>
        <span class="muted" style="margin-left:auto">TZ locale</span>
      </div>
      <div class="toolbar">
        <div class="filters">
          <input type="date" id="datePicker" />
          <select id="techFilter"><option value="">Tous techniciens</option></select>
          <select id="typeFilter"><option value="">Tous types</option></select>
          <input type="text" id="searchInput" placeholder="Rechercher (ticket / site / note)" />
        </div>
        <div class="actions">
          <label class="btn" for="excelInput">üì• Importer Excel</label>
          <input id="excelInput" type="file" accept=".xlsx,.xls" hidden />
          <button id="btnAdd" class="primary">+ Ajouter</button>
          <button id="btnExport">Exporter XLS</button>
          <button id="btnSettings">Param√®tres</button>
          <button id="btnOpenPlanif" title="Planification Techniciens" class="ok">üìã Ouvrir la Planification</button>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="cards">
      <section class="card">
        <h2 class="flex">Planning du <span id="dayLabel" class="badge">‚Äî</span><span class="right muted" id="countLabel"></span></h2>
        <table class="list" id="eventsTable">
          <thead><tr>
            <th>Ticket</th><th>Heure</th><th>Site / Ville</th><th>Type</th><th>Technicien</th><th>Infos</th><th></th>
          </tr></thead>
          <tbody id="eventsBody"></tbody>
        </table>
      </section>
      <section class="card">
        <h2>Journal</h2>
        <div id="log" class="muted" style="white-space:pre-wrap"></div>
      </section>
    </div>
  </main>

  <!-- Modale ajout / √©dition -->
  <dialog id="dlgEdit">
    <form method="dialog">
      <div class="modal-head"><strong id="dlgTitle">Nouvel √©v√©nement</strong></div>
      <div class="modal-body grid2">
        <div class="field"><label>Ticket</label><input type="text" id="f_ticket" placeholder="Num√©ro du ticket" /></div>
        <div class="field"><label>Date</label><input type="date" id="f_date" required /></div>
        <div class="field"><label>Heure (HH:mm)</label><input type="time" id="f_time" required /></div>
        <div class="field"><label>Site / Ville</label><input type="text" id="f_site" required placeholder="Ex. 4001 MARIE BLACHERE VALENCE CASINO - BBG" /></div>
        <div class="field"><label>Type</label><input type="text" id="f_type" required placeholder="INFRA, ROCADE, AUDIT‚Ä¶" /></div>
        <div class="field"><label>Technicien</label><input type="text" id="f_technicien" /></div>
        <div class="field"><label>HNO</label><select id="f_hno"><option value="false">Non</option><option value="true">Oui</option></select></div>
        <div class="field" style="grid-column:1/-1"><label>Notes</label><input type="text" id="f_notes" placeholder="Optionnel" /></div>
      </div>
      <div class="modal-foot">
        <button id="btnDelete" class="danger" value="delete" style="display:none">Supprimer</button>
        <span style="flex:1"></span>
        <button value="cancel">Annuler</button>
        <button id="btnSave" class="ok" value="default">Enregistrer</button>
      </div>
    </form>
  </dialog>

  <!-- Modale Param√®tres -->
  <dialog id="dlgSettings">
    <form method="dialog">
      <div class="modal-head"><strong>Param√®tres</strong></div>
      <div class="modal-body">
        <div class="grid3">
          <div class="field"><label>Ann√©e par d√©faut pour feuilles Excel (DDMM)</label><input type="number" id="s_year" value="2025" min="2020" max="2100" /></div>
          <div class="field"><label>Dur√©e par d√©faut (minutes) pour ICS</label><input type="number" id="s_dur" value="120" min="15" step="15" /></div>
          <div class="field"><label>Exporter: inclure d√©j√† export√©s ?</label><select id="s_include_exported"><option value="false">Non</option><option value="true">Oui</option></select></div>
        </div>
        <div class="sep"></div>
        <div class="grid4">
          <div class="field"><label>Mapping colonne 1</label><select id="map0"></select></div>
          <div class="field"><label>Mapping colonne 2</label><select id="map1"></select></div>
          <div class="field"><label>Mapping colonne 3</label><select id="map2"></select></div>
          <div class="field"><label>Mapping colonne 4</label><select id="map3"></select></div>
          <div class="field"><label>Mapping colonne 5</label><select id="map4"></select></div>
        </div>
        <p class="hint">Le mapping correspond, dans l'ordre, √† : <code>ticket</code>, <code>site</code>, <code>type</code>, <code>technicien</code>, <code>heure</code>.</p>
        <div class="sep"></div>
        <div class="grid2">
          <div class="field"><label>Supabase URL</label><input type="text" id="s_supabase_url" placeholder="https://xxxx.supabase.co" /></div>
          <div class="field"><label>Supabase Anon Key</label><input type="text" id="s_supabase_key" placeholder="eyJ..." /></div>
        </div>
        <p class="hint">URL & cl√© publique anon sont stock√©es dans <em>localStorage</em>.</p>
      </div>
      <div class="modal-foot">
        <button value="cancel">Fermer</button>
        <button id="btnSaveSettings" class="ok" value="default">Enregistrer</button>
      </div>
    </form>
  </dialog>

  <div id="toast" class="toast" style="display:none"></div>

  <!-- D√©pendances globales -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

  <!-- Script principal -->
  <script id="app-js">
  'use strict';

  (function(){
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', startApp);
    } else {
      startApp();
    }

    function startApp(){

      // ===== Utils =====
      const $ = (s,root=document)=>root.querySelector(s);
      const $$ = (s,root=document)=>[...root.querySelectorAll(s)];
      const toast = (msg,ms=2500)=>{const t=$('#toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',ms)};
      const pad = n=>String(n).padStart(2,'0');
      const escapeHtml = s =>
        String(s || '').replace(/[&<>"']/g, c => (
          {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]
        ));
      const toMailDate = iso=> dayjs(iso).format('DD/MM/YYYY');

      // ===== State (Agenda) =====
      const state = {
        supa:null, supaCreds:{url:'',key:''},
        settings:{year:2025, icsDuration:120, includeExported:false},
        mapping:['ticket','site','type','technicien','heure'],
        currentDate: dayjs().format('YYYY-MM-DD'),
        events:[], editing:null, options:{techs:new Set(), types:new Set()}
      };

      // ===== Prefs =====
      function loadPrefs(){
        try{
          Object.assign(state.settings, JSON.parse(localStorage.getItem('agenda_settings')||'{}'));
          const m = JSON.parse(localStorage.getItem('agenda_mapping')||'[]'); if(m.length===5) state.mapping=m;
          const c = JSON.parse(localStorage.getItem('agenda_supabase')||'{}'); if(c.url&&c.key){ state.supaCreds=c; initSupabase(); }
        }catch(e){}
      }
      function savePrefs(){
        localStorage.setItem('agenda_settings', JSON.stringify(state.settings));
        localStorage.setItem('agenda_mapping', JSON.stringify(state.mapping));
        localStorage.setItem('agenda_supabase', JSON.stringify(state.supaCreds));
        toast('Param√®tres enregistr√©s');
      }

      // ===== UI (Agenda) =====
      function setLive(on){
        $('#liveLabel').textContent = on?'on':'off';
        $('#liveState').style.borderColor = on? '#2b6f45':'#203049';
        $('#liveState').style.background = on? 'linear-gradient(180deg,#1d3c2a,#13271c)':'#0f1622';
      }
      function guessBadges(type){
        const t=(type||'').toLowerCase();
        if(t.includes('infra')) return 'badge infra';
        if(t.includes('rocade')) return 'badge rocade';
        if(t.includes('audit')) return 'badge audit';
        return 'badge';
      }
      function updateFilters(){
        const techSel=$('#techFilter'), typeSel=$('#typeFilter');
        const tv=techSel.value, yv=typeSel.value;
        techSel.innerHTML='<option value="">Tous techniciens</option>'+Array.from(state.options.techs).filter(Boolean).sort().map(v=>`<option>${escapeHtml(v)}</option>`).join('');
        typeSel.innerHTML='<option value="">Tous types</option>'+Array.from(state.options.types).filter(Boolean).sort().map(v=>`<option>${escapeHtml(v)}</option>`).join('');
        techSel.value=tv; typeSel.value=yv;
      }
      function fmtDateLabel(d){ return dayjs(d).format('dddd DD MMM YYYY'); }
      function render(){
        $('#dayLabel').textContent=fmtDateLabel(state.currentDate);
        const q=$('#searchInput').value.toLowerCase().trim();
        const tf=$('#techFilter').value, yf=$('#typeFilter').value;
        const rows = state.events
          .filter(e=>e.date===state.currentDate)
          .filter(e=>!tf||e.technicien===tf)
          .filter(e=>!yf||e.type===yf)
          .filter(e=>!q || (String(e.ticket||'')+e.site+e.type+e.technicien+(e.notes||'')).toLowerCase().includes(q))
          .sort((a,b)=> (a.start_time||'').localeCompare(b.start_time||''));
        const body=$('#eventsBody'); body.innerHTML='';
        rows.forEach(e=>{
          const tr=document.createElement('tr'); tr.className='row';
          tr.innerHTML=`
            <td>${escapeHtml(e.ticket||'')}</td>
            <td><strong>${e.start_time||''}</strong>${e.hno?' <span class="tag hno">HNO</span>':''}</td>
            <td>${escapeHtml(e.site||'')}</td>
            <td><span class="${guessBadges(e.type)}">${escapeHtml(e.type||'')}</span></td>
            <td>${escapeHtml(e.technicien||'')}</td>
            <td class="muted">${escapeHtml(e.notes||'')}</td>
            <td><button data-id="${e.id}" data-act="edit" class="small">‚úèÔ∏è</button></td>`;
          body.appendChild(tr);
        });
        $('#countLabel').textContent = `${rows.length} intervention(s)`;
        updateFilters();
      }

      // ===== Supabase =====
      function initSupabase(){
        try{
          state.supa = window.supabase.createClient(state.supaCreds.url, state.supaCreds.key, { auth:{persistSession:false} });
          subscribeRealtime(); refreshDay();
        }catch(err){ console.error(err); toast('Supabase non initialis√©'); }
      }
      function subscribeRealtime(){
        if(!state.supa) return;
        state.supa.channel('events-changes')
          .on('postgres_changes',{event:'*',schema:'public',table:'events'}, payload=>{ log('Realtime: '+payload.eventType); refreshDay(); })
          .subscribe((status)=> setLive(status==='SUBSCRIBED'));
      }
      async function upsertEvents(items){
        if(!state.supa) throw new Error('Supabase non configur√©');
        const {data,error}=await state.supa.from('events').upsert(items,{onConflict:'event_uid'}).select();
        if(error) throw error; return data;
      }
      async function deleteEvent(id){ const {error}=await state.supa.from('events').delete().eq('id',id); if(error) throw error; }
      async function fetchDay(date){ if(!state.supa) return []; const {data,error}=await state.supa.from('events').select('*').eq('date',date).order('start_time',{ascending:true}); if(error) throw error; return data||[]; }
      async function fetchRange(start,end){
        if(!state.supa) return [];
        let q=state.supa.from('events').select('*');
        if(start) q=q.gte('date',start);
        if(end) q=q.lte('date',end);
        const {data,error}=await q.order('date',{ascending:true}).order('start_time',{ascending:true});
        if(error) throw error; return data||[];
      }
      async function refreshDay(){ if(!state.supa) return; const list=await fetchDay(state.currentDate); mergeEvents(list); }
      function mergeEvents(list){
        list.forEach(e=>{ if(e?.technicien) state.options.techs.add(e.technicien); if(e?.type) state.options.types.add(e.type); });
        state.events = state.events.filter(e=>e.date!==state.currentDate).concat(list);
        render();
      }

      // ===== Import Excel (Agenda) =====
      function parseHour(raw){
        if(!raw) return {time:'08:00',hno:false};
        const s=String(raw).trim(); const hno=/HNO/i.test(s);
        const cleaned=s.replace(/\(HNO\)/ig,'').replace(/h/ig,':').replace(/\s+/g,'');
        const m=cleaned.match(/^(\d{1,2})(?::?(\d{2}))?$/);
        const hh = pad(m ? m[1] : '8');
        const mm = m && m[2] ? m[2] : '00';
        return {time:`${hh}:${mm}`, hno};
      }
      function sheetNameToDate(name){
        const m=String(name).trim().match(/^(\d{2})(\d{2})$/); if(!m) return null;
        const d=`${state.settings.year}-${m[2]}-${m[1]}`; return dayjs(d).isValid()? dayjs(d).format('YYYY-MM-DD') : null;
      }
      function parseRowsToEvents(rows, sheetDate){
        const map=state.mapping, out=[];
        rows.forEach(r=>{
          if(!r) return;
          let cells=r.filter(c=>c!==undefined&&c!==null&&String(c).trim()!==''); if(cells.length===0) return;
          while(cells.length<5) cells.push('');
          const rec={date:sheetDate,ticket:'',site:'',type:'',technicien:'',start_time:'',hno:false,notes:''};
          const defaults=['ticket','site','type','technicien','heure'];
          for(let i=0;i<5;i++){
            const field=map[i]||defaults[i]; const val=String(cells[i]??'').trim();
            if(field==='heure'){ const {time,hno}=parseHour(val); rec.start_time=time; if(hno) rec.hno=true; }
            else if(field==='ticket'){ rec.ticket=val; }
            else if(field in rec){ rec[field]=val; }
          }
          if(!rec.ticket && !rec.site && !rec.type && !rec.technicien) return;
          out.push(rec);
        });
        return out;
      }
      async function sha1(text){
        if(window.crypto?.subtle){
          const enc=new TextEncoder().encode(text); const buf=await crypto.subtle.digest('SHA-1',enc);
          return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
        }
        let h=0; for(let i=0;i<text.length;i++){h=((h<<5)-h)+text.charCodeAt(i); h|=0} return 'f'+(h>>>0).toString(16);
      }
      function handleExcel(file){
        const reader=new FileReader();
        reader.onload = async (e)=>{
          try{
            const wb=XLSX.read(e.target.result,{type:'binary'}); const all=[];
            for(const name of wb.SheetNames){
              const d=sheetNameToDate(name); if(!d){ log('Feuille ignor√©e: '+name); continue; }
              const ws=wb.Sheets[name]; const rows=XLSX.utils.sheet_to_json(ws,{header:1,raw:true});
              all.push(...parseRowsToEvents(rows,d));
            }
            if(!all.length){ toast('Aucune donn√©e d√©tect√©e. V√©rifie les noms de feuilles (DDMM).'); return; }
            for(const ev of all){
              const uidBase = `${ev.date}|${(ev.ticket||'').toLowerCase().trim()}|${(ev.site||'').toLowerCase().trim()}|${(ev.technicien||'').toLowerCase().trim()}|${ev.start_time||''}`;
              ev.event_uid = await sha1(uidBase);
            }
            const saved = await upsertEvents(all);
            toast(`Import termin√©: ${saved.length} enregistrements`);
            if (all.some(x => x.date === state.currentDate)) await refreshDay();
          } catch (err) {
            console.error(err);
            toast("Erreur √† l'import: " + (err && err.message ? err.message : err));
          }
        };
        reader.readAsBinaryString(file);
      }

      // ===== Editor / Export (Agenda) =====
      function openEditor(ev=null){
        state.editing=ev||null;
        $('#dlgTitle').textContent=ev?'Modifier l‚Äô√©v√©nement':'Nouvel √©v√©nement';
        $('#btnDelete').style.display=(ev&&ev.id)?'inline-flex':'none';
        $('#f_ticket').value=ev?.ticket??'';
        $('#f_date').value=ev?.date??state.currentDate;
        $('#f_time').value=ev?.start_time??'';
        $('#f_site').value=ev?.site??'';
        $('#f_type').value=ev?.type??'';
        $('#f_technicien').value=ev?.technicien??'';
        $('#f_hno').value=String(ev?.hno??false);
        $('#f_notes').value=ev?.notes??'';
        $('#dlgEdit').showModal();
      }
      async function openExport(){
        const data=await fetchRange(state.currentDate,state.currentDate);
        const rows=data.map(e=>({Date:toMailDate(e.date),Heure:e.start_time||'', 'Type de travaux':e.type||'', 'Nom du tech':e.technicien||''}));
        const ws=XLSX.utils.json_to_sheet(rows); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Interventions');
        const bin=XLSX.write(wb,{bookType:'xlsx',type:'binary'}); const buf=new ArrayBuffer(bin.length); const view=new Uint8Array(buf);
        for(let i=0;i<bin.length;i++) view[i]=bin.charCodeAt(i)&0xFF;
        const blob=new Blob([buf],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
        const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`export_inters_${state.currentDate}.xlsx`; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1000);
        toast(`Export√© ${rows.length} interventions`);
      }
      function log(s){ const el=$('#log'); el.textContent=(dayjs().format('HH:mm:ss')+'  '+s+'\n')+el.textContent; }

      // ======= PLANIFICATION PAGE (nouvel onglet) =======
      function openPlanificationTab(){
        const w = window.open('', '_blank');
        if(!w){ toast('Popup bloqu√©e par le navigateur'); return; }

        // 1) Base document
        const doc = w.document;
        doc.open();
        doc.write('<!doctype html><html lang="fr"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Planification Techniciens ‚Äî Int√©gr√©e</title></head><body></body></html>');
        doc.close();

        // 2) Styles (pas de template string g√©ant)
        const style = doc.createElement('style');
        style.textContent = `
:root{ --bg:#0b0f14; --panel:#101823; --muted:#7a8aa1; --text:#e6edf6; --accent:#4cc2ff; --ok:#78e08f; --danger:#ff6b6b; --warn:#ffc048; --radius:16px }
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:linear-gradient(180deg,#0a0f14,#0d141d);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
header{position:sticky;top:0;z-index:10;background:rgba(10,15,20,.8);backdrop-filter:saturate(140%) blur(10px);border-bottom:1px solid #17202e}
.wrap{max-width:1100px;margin:0 auto;padding:16px}
.brand{display:flex;gap:10px;align-items:center}
.brand .dot{width:12px;height:12px;border-radius:50%;background:radial-gradient(circle at 30% 30%, #8ee0ff, #4cc2ff)}
.brand h1{margin:0;font-size:18px;letter-spacing:.2px}
main{max-width:1100px;margin:16px auto;padding:0 16px 60px}
.grid{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:900px){.grid{grid-template-columns:330px 1fr}}
.card{background:linear-gradient(180deg,#0f1622,#0c121b);border:1px solid #1a2535;border-radius:var(--radius);padding:16px;box-shadow:0 6px 20px rgba(0,0,0,.35)}
.card h2{margin:0 0 10px 0;font-size:16px}
.muted{color:var(--muted)}
.row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
.row4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px}
label{font-size:12px;color:#a9c2db}
input,select,button{background:#0f1622;color:#e6edf6;border:1px solid #1d2a3c;border-radius:12px;padding:10px 12px;outline:none}
button:hover{border-color:#2b3d57}
button.primary{background:linear-gradient(180deg,#1b283c,#142035);border-color:#274160}
button.ok{background:linear-gradient(180deg,#204231,#1a3527);border-color:#2d6444}
button.warn{background:linear-gradient(180deg,#3e310d,#2b2109);border-color:#6b5017}
button.danger{background:linear-gradient(180deg,#3d1515,#2a0e0e);border-color:#6a2323}
.toolbar{display:flex;gap:8px;flex-wrap:wrap}
.tech-list{max-height:260px;overflow:auto;border:1px solid #1b2a3e;border-radius:12px;padding:8px}
.tech-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border:1px solid #1b2940;border-radius:10px;margin-bottom:8px}
.pill{display:inline-flex;gap:6px;align-items:center;border:1px solid #274160;border-radius:999px;padding:4px 8px;color:#bcd}
.site-row{display:grid;grid-template-columns:1.6fr 1.1fr .8fr auto;gap:8px;align-items:center;margin-bottom:8px}
.site-row .rm{padding:8px 10px}
.hint{font-size:12px;color:#9cb1c9}
.sep{height:1px;background:#162133;margin:12px 0}
.toast{position:fixed;right:14px;bottom:14px;background:#0f1622;color:#dfefff;border:1px solid #263652;border-radius:12px;padding:10px 12px;box-shadow:0 10px 30px rgba(0,0,0,.3)}
`;
        doc.head.appendChild(style);

        // 3) Structure HTML
        const header = doc.createElement('header');
        header.innerHTML = `
<div class="wrap">
  <div class="brand">
    <span class="dot"></span><h1>Planification Techniciens ‚Äî Int√©gr√©e</h1>
    <span class="pill" title="Stockage">LocalStorage</span>
    <span class="muted" style="margin-left:auto">v2</span>
  </div>
</div>`;
        doc.body.appendChild(header);

        const main = doc.createElement('main');
        main.innerHTML = `
<div class="grid">
  <section class="card">
    <h2>1) Annuaire techniciens</h2>
    <p class="hint">Excel attendu : <strong>Nom</strong>, <strong>Pr√©nom</strong>, <strong>D√©partements</strong> (13, 30, 34 / 971‚Ä¶), <strong>Ville</strong>, <strong>T√©l√©phone</strong>, <strong>Secteurs</strong>.</p>
    <div class="toolbar" style="margin:8px 0 6px">
      <label class="pill" for="excelInternes">üì• Importer INTERNES</label>
      <input id="excelInternes" type="file" accept=".xlsx,.xls" hidden />
      <label class="pill" for="excelSousT">üì• Importer SOUS-TRAITANTS</label>
      <input id="excelSousT" type="file" accept=".xlsx,.xls" hidden />
      <button id="btnClearInternes" class="danger">Effacer Internes</button>
      <button id="btnClearSousT" class="danger">Effacer Sous-traitants</button>
    </div>
    <div class="sep"></div>
    <div class="toolbar" style="gap:12px;flex-wrap:wrap">
      <div>
        <label style="display:block;font-size:12px;color:#a9c2db">D√©partement (2 ou 3 ch., 2A/2B OK)</label>
        <input type="text" id="deptInput" placeholder="ex. 13 ou 971" maxlength="3" />
      </div>
      <div>
        <label style="display:block;font-size:12px;color:#a9c2db">Rechercher (d√©but Nom/Pr√©nom)</label>
        <input type="text" id="searchTech" placeholder="ex. Jo pour Jonathan" />
      </div>
      <div class="muted" style="margin-left:auto"><span id="foundCount">0</span> r√©sultat(s)</div>
    </div>
    <div id="techList" class="tech-list"></div>
  </section>

  <section class="card">
    <h2>2) Composer les interventions pour <span id="selTechLabel" class="pill">‚Äî</span></h2>
    <div class="row3">
      <div>
        <label>Technicien (dans ce d√©partement)</label>
        <select id="techSelect"></select>
      </div>
      <div>
        <label>D√©partement</label>
        <input type="text" id="deptSelected" placeholder="13" maxlength="3" />
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="btnAddSite" class="primary">+ Ajouter un site</button>
      </div>
    </div>
    <div class="sep"></div>
    <div id="sitesContainer"></div>
    <div class="toolbar" style="margin-top:8px">
      <button id="btnSaveDraft" class="ok">Enregistrer pour ce technicien</button>
      <button id="btnExportPlanif" class="primary">Exporter Planif tech</button>
      <button id="btnClearDraft" class="warn">Vider le brouillon du tech</button>
    </div>
    <p class="hint">Chaque site : <em>Raison sociale / Ville</em>, <em>Type</em>, <em>HNO</em>. L‚Äôexport cr√©e un XLS (<strong>D√©partement</strong>, <strong>Raison sociale</strong>, <strong>Date</strong>, <strong>Heure</strong>).</p>
  </section>
</div>
<div id="toast" class="toast" style="display:none"></div>`;
        doc.body.appendChild(main);

        // 4) Charger XLSX (CDN)
        const xlsx = doc.createElement('script');
        xlsx.src = 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
        doc.body.appendChild(xlsx);

        // 5) Utilitaires + logique (fen√™tre enfant)
        const helper = doc.createElement('script');
        helper.textContent = `
const $ = (s,root=document)=>root.querySelector(s);
const $$ = (s,root=document)=>[...root.querySelectorAll(s)];
const toast = (m,ms=2200)=>{ const t=$('#toast'); t.textContent=m; t.style.display='block'; setTimeout(()=>t.style.display='none',ms) };
const pad2 = v => String(v).padStart(2,'0');
const normalize = s => String(s||'').normalize('NFD').replace(/[\\u0300-\\u036f]/g,'').toLowerCase().trim();
const escapeTxt = s => String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

const state = {
  internes: JSON.parse(localStorage.getItem('pt_techs_internes')||'[]'),
  sousT: JSON.parse(localStorage.getItem('pt_techs_soustraitants')||'[]'),
  draft: JSON.parse(localStorage.getItem('pt_draft')||'{}'),
  lastDept: localStorage.getItem('pt_lastDept')||'',
  view: 'all'
};

function normDeptToken(tok){
  let t = String(tok||'').trim().toUpperCase();
  if(!t) return '';
  if(t==='2A'||t==='2B') return '20';
  if(/^97[1-6]$/.test(t)) return t;
  const num = t.replace(/[^0-9]/g,'');
  if(!num) return '';
  if(num.length===3) return num;
  return pad2(num);
}
function parseDeptList(raw){
  const s = String(raw||'').replace(/[^0-9A-Za-z,;\\s]/g,' ');
  const parts = s.split(/[;,\s]+/).filter(Boolean);
  const out = [...new Set(parts.map(normDeptToken).filter(Boolean))];
  out.sort((a,b)=> (a.length-b.length) || a.localeCompare(b,'fr',{numeric:true}));
  return out;
}
function normalizePhone(s){
  const raw = String(s||'').trim();
  if(!raw) return '';
  const cl = raw.replace(/[^\\d+]/g,'');
  if(/^0[1-9]\\d{8}$/.test(cl)) return '+33'+cl.slice(1);
  return cl;
}
function keyName(nom, prenom){ return normalize((nom||'')+' '+(prenom||'')); }
function dedupe(list){
  const map=new Map();
  for(const t of list){
    const k=keyName(t.nom,t.prenom);
    const depts = parseDeptList(t.depts?.join? t.depts.join(','): t.depts||'');
    const secteurs = Array.isArray(t.secteurs)? t.secteurs : String(t.secteurs||'').split(/[;,]/).map(x=>x.trim()).filter(Boolean);
    const rec = { nom:(t.nom||'').trim(), prenom:(t.prenom||'').trim(), depts, ville:(t.ville||'').trim(), tel:normalizePhone(t.tel||''), secteurs };
    const prev = map.get(k);
    if(!prev) map.set(k, rec);
    else{
      const nd=[...new Set((prev.depts||[]).concat(rec.depts||[]))].sort((a,b)=> (a.length-b.length)||a.localeCompare(b,'fr',{numeric:true}));
      const ns=[...new Set((prev.secteurs||[]).concat(rec.secteurs||[]))];
      map.set(k, { nom:prev.nom||rec.nom, prenom:prev.prenom||rec.prenom, depts:nd, ville:rec.ville||prev.ville, tel:rec.tel||prev.tel, secteurs:ns });
    }
  }
  return [...map.values()];
}
function saveInternes(){ localStorage.setItem('pt_techs_internes', JSON.stringify(state.internes)); }
function saveSousT(){ localStorage.setItem('pt_techs_soustraitants', JSON.stringify(state.sousT)); }
function saveDraft(){ localStorage.setItem('pt_draft', JSON.stringify(state.draft)); }
function setLastDept(v){ state.lastDept=v; localStorage.setItem('pt_lastDept', v); }

function parseTechExcel(wb){
  const out=[];
  for(const name of wb.SheetNames){
    const ws=wb.Sheets[name];
    const rows = window.XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
    for(const r of rows){
      if(!r||!r.length) continue;
      const nom=(r[0]||'').toString().trim(), prenom=(r[1]||'').toString().trim();
      const depts=parseDeptList((r[2]||'').toString());
      const ville=(r[3]||'').toString().trim(), tel=(r[4]||'').toString().trim();
      const secteursRaw=(r[5]||'').toString();
      const secteurs=secteursRaw? secteursRaw.split(/[;,]/).map(x=>x.trim()).filter(Boolean):[];
      if(!(nom||prenom) || depts.length===0) continue;
      out.push({nom,prenom,depts,ville,tel,secteurs});
    }
  }
  return out;
}

function matchDept(depts, q){
  const nq = normDeptToken(String(q||'').trim().toUpperCase());
  if(!nq) return true;
  return (depts||[]).some(d => d===nq);
}
function startsPrefix(t, q){
  const n = normalize(q||'');
  if(!n) return true;
  return normalize(t.prenom||'').startsWith(n) || normalize(t.nom||'').startsWith(n);
}
function getVisibleList(){
  const dept = $('#deptInput').value;
  const q = $('#searchTech').value;
  let base = [];
  if(state.view==='all') base = (state.internes||[]).concat(state.sousT||[]);
  else if(state.view==='internes') base = state.internes||[];
  else base = state.sousT||[];
  return base.filter(t => matchDept(t.depts, dept) && startsPrefix(t,q))
             .sort((a,b)=> (a.nom+a.prenom).localeCompare(b.nom+b.prenom,'fr',{sensitivity:'base'}));
}
function renderTechList(){
  const list = getVisibleList();
  $('#foundCount').textContent = String(list.length);
  const box = $('#techList'); box.innerHTML='';
  if(!list.length){ box.innerHTML='<div class="muted">Aucun technicien pour ce filtre.</div>'; return; }
  list.forEach(t=>{
    const badge = (state.view==='soustraitants' || (state.view==='all') && (state.sousT||[]).some(x=> keyName(x.nom,x.prenom)===keyName(t.nom,t.prenom)) ) ? 'Sous-traitant' : 'Interne';
    const el = document.createElement('div'); el.className='tech-item';
    el.innerHTML = \`
      <div>
        <strong>\${escapeTxt(t.prenom||'')} \${escapeTxt(t.nom||'')}</strong>
        <span class="pill">\${badge}</span><br/>
        <span class="muted">D√©pts: \${escapeTxt((t.depts||[]).join(', '))}</span> ¬∑
        <span class="muted">Ville: \${escapeTxt(t.ville||'')}</span> ¬∑
        <span class="muted">Tel: \${escapeTxt(normalizePhone(t.tel||''))}</span> ¬∑
        <span class="muted">Secteurs: \${escapeTxt((t.secteurs||[]).join(', '))}</span>
      </div>
      <div><button class="primary" data-name="\${escapeTxt((t.prenom||'')+' '+(t.nom||''))}">Choisir</button></div>\`;
    box.appendChild(el);
  });
}

function fillTechSelect(){
  const sel = $('#techSelect'); sel.innerHTML='';
  const list = getVisibleList();
  if(!list.length){ sel.innerHTML='<option value="">‚Äî</option>'; $('#selTechLabel').textContent='‚Äî'; return; }
  sel.innerHTML = list.map(t => '<option>'+escapeTxt((t.prenom||'')+' '+(t.nom||''))+'</option>').join('');
  $('#selTechLabel').textContent = sel.value || '‚Äî';
  renderSites();
}

function keyFor(dept, tech){ return dept+'__'+tech; }
function addSiteRow(data={}){
  const row = document.createElement('div'); row.className='site-row';
  row.innerHTML = \`
    <input type="text" class="site" placeholder="Raison sociale / Ville" value="\${(data.site||'').replace(/"/g,'&quot;')}">
    <select class="type">
      <option\${data.type==='Audit site isol√©'?' selected':''}>Audit site isol√©</option>
      <option\${data.type==='Audit site mitoyen'?' selected':''}>Audit site mitoyen</option>
      <option\${data.type==='Travaux lien'?' selected':''}>Travaux lien</option>
      <option\${data.type==='Travaux rocade'?' selected':''}>Travaux rocade</option>
      <option\${data.type==='Travaux lien & rocade'?' selected':''}>Travaux lien & rocade</option>
    </select>
    <select class="hno">
      <option value="Non"\${data.hno==='Non'||!data.hno?' selected':''}>HNO : Non</option>
      <option value="Oui"\${data.hno==='Oui'?' selected':''}>HNO : Oui</option>
    </select>
    <button class="rm">üóëÔ∏è</button>\`;
  $('#sitesContainer').appendChild(row);
  row.querySelector('.rm').addEventListener('click', ()=>{ row.remove(); saveDraftFromUI(); });
}
function getCurrentSelection(){
  const dept=($('#deptSelected').value||'').trim();
  const tech=($('#techSelect').value||'').trim();
  const nd = normDeptToken(dept);
  if(!/^([0-9]{2}|97[1-6])$/.test(nd)) return {ok:false,msg:'Renseigne le d√©partement (2 chiffres ou 971-976).'};
  if(!tech) return {ok:false,msg:'Choisis un technicien.'};
  return {ok:true, dept:nd, tech};
}
function renderSites(){
  const sel=getCurrentSelection();
  const c=$('#sitesContainer'); c.innerHTML='';
  if(!sel.ok) return;
  const key=keyFor(sel.dept, sel.tech);
  const list = (state.draft[key]||[]);
  if(!list.length){ addSiteRow(); return; }
  list.forEach(addSiteRow);
}
function saveDraftFromUI(){
  const sel=getCurrentSelection(); if(!sel.ok){ toast(sel.msg); return; }
  const items=[];
  $$('.site-row').forEach(r=>{
    const site=r.querySelector('.site').value.trim();
    const type=r.querySelector('.type').value.trim();
    const hno=r.querySelector('.hno').value.trim();
    if(site) items.push({site,type,hno});
  });
  state.draft[keyFor(sel.dept, sel.tech)] = items;
  localStorage.setItem('pt_draft', JSON.stringify(state.draft));
  toast('Brouillon enregistr√©');
}
function clearDraft(){
  const sel=getCurrentSelection(); if(!sel.ok){ toast(sel.msg); return; }
  delete state.draft[keyFor(sel.dept, sel.tech)];
  localStorage.setItem('pt_draft', JSON.stringify(state.draft));
  renderSites(); toast('Brouillon vid√©');
}

function openExportTab(){
  const sel = getCurrentSelection(); if(!sel.ok){ toast(sel.msg); return; }
  const key = keyFor(sel.dept, sel.tech);
  const list = (state.draft[key]||[]).map(it=> ({ dept: sel.dept, site: it.site }));
  if(!list.length){ toast('Aucun site √† exporter'); return; }

  const rows = [['D√©partement','Raison sociale','Date','Heure'], ...list.map(r=>[r.dept, r.site, '', ''])];
  const wb = window.XLSX.utils.book_new();
  const ws = window.XLSX.utils.aoa_to_sheet(rows);
  window.XLSX.utils.book_append_sheet(wb, ws, 'Planif');
  const bin = window.XLSX.write(wb, {bookType:'xlsx', type:'binary'});
  const buf = new ArrayBuffer(bin.length);
  const view = new Uint8Array(buf);
  for(let i=0;i<bin.length;i++) view[i] = bin.charCodeAt(i) & 0xFF;
  const blob = new Blob([buf], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
  const a = document.createElement('a');
  const safeTech = sel.tech.replace(/[^a-z0-9_\\-]+/ig,'_');
  a.href = URL.createObjectURL(blob);
  a.download = \`planif_\${sel.dept}_\${safeTech}.xlsx\`;
  a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
}

function renderAfterImport(){ if(state.lastDept) $('#deptInput').value = state.lastDept; renderTechList(); fillTechSelect(); }

function bindUI(){
  // Imports fichiers
  $('#excelInternes').addEventListener('change', e=>{
    const f=e.target.files[0]; if(!f) return;
    const r=new FileReader();
    r.onload=ev=>{
      try{
        const wb=XLSX.read(ev.target.result,{type:'binary'});
        const list=parseTechExcel(wb);
        state.internes = dedupe([...(state.internes||[]), ...list]);
        saveInternes(); toast('Internes charg√©s : '+state.internes.length);
        renderAfterImport();
      }catch(err){ console.error(err); toast('Erreur import Internes'); }
    };
    r.readAsBinaryString(f); e.target.value='';
  });
  $('#excelSousT').addEventListener('change', e=>{
    const f=e.target.files[0]; if(!f) return;
    const r=new FileReader();
    r.onload=ev=>{
      try{
        const wb=XLSX.read(ev.target.result,{type:'binary'});
        const list=parseTechExcel(wb);
        state.sousT = dedupe([...(state.sousT||[]), ...list]);
        saveSousT(); toast('Sous-traitants charg√©s : '+state.sousT.length);
        renderAfterImport();
      }catch(err){ console.error(err); toast('Erreur import Sous-traitants'); }
    };
    r.readAsBinaryString(f); e.target.value='';
  });

  // Effacements
  $('#btnClearInternes').addEventListener('click', ()=>{ state.internes=[]; saveInternes(); toast('Internes effac√©s'); renderAfterImport(); });
  $('#btnClearSousT').addEventListener('click', ()=>{ state.sousT=[]; saveSousT(); toast('Sous-traitants effac√©s'); renderAfterImport(); });

  // Filtrage
  $('#deptInput').addEventListener('input', ()=>{ setLastDept($('#deptInput').value.trim().toUpperCase()); renderTechList(); fillTechSelect(); });
  $('#searchTech').addEventListener('input', ()=>{ renderTechList(); fillTechSelect(); });

  // S√©lection tech / dept
  $('#techSelect').addEventListener('change', ()=>{ $('#selTechLabel').textContent = $('#techSelect').value || '‚Äî'; renderSites(); });
  $('#deptSelected').addEventListener('input', ()=> renderSites());
  $('#btnAddSite').addEventListener('click', ()=> addSiteRow());

  // Brouillon + Export
  $('#btnSaveDraft').addEventListener('click', saveDraftFromUI);
  $('#btnClearDraft').addEventListener('click', clearDraft);
  $('#btnExportPlanif').addEventListener('click', openExportTab);

  // Premi√®re passe
  if(state.lastDept) $('#deptInput').value = state.lastDept;
  renderTechList(); fillTechSelect();
}

// Attendre que XLSX soit charg√© avant de binder
(function waitX(){ if(!window.XLSX){ return setTimeout(waitX, 50); } bindUI(); })();
`;
        doc.body.appendChild(helper);
      }

      // ===== Bindings Agenda =====
      function bindUI(){
        $('#datePicker').value = state.currentDate;
        $('#datePicker').addEventListener('change', async (e) => {
          state.currentDate = e.target.value;
          await refreshDay();
        });
        $('#techFilter').addEventListener('change', render);
        $('#typeFilter').addEventListener('change', render);
        $('#searchInput').addEventListener('input', render);

        $('#excelInput').addEventListener('change', (e) => {
          const f = e.target.files[0];
          if (f) handleExcel(f);
          e.target.value = '';
        });

        $('#btnAdd').addEventListener('click', () => openEditor());
        $('#btnExport').addEventListener('click', openExport);
        $('#btnSettings').addEventListener('click', openSettings);

        $('#eventsBody').addEventListener('click', (e) => {
          const btn = e.target.closest('button');
          if (!btn) return;
          const id = btn.getAttribute('data-id');
          const act = btn.getAttribute('data-act');
          const ev = state.events.find((x) => x.id === id);
          if (!ev) return;
          if (act === 'edit') openEditor(ev);
        });

        $('#btnOpenPlanif').addEventListener('click', openPlanificationTab);
      }

      function openSettings(){
        $('#s_year').value = state.settings.year;
        $('#s_dur').value = state.settings.icsDuration;
        $('#s_include_exported').value = String(state.settings.includeExported);

        const opts = ['ticket','site','type','technicien','heure'];
        ['map0','map1','map2','map3','map4'].forEach((id,i) => {
          const s = $('#'+id);
          s.innerHTML = '';
          opts.forEach((v) => {
            const o = document.createElement('option');
            o.value = v;
            o.textContent = v;
            s.appendChild(o);
          });
          s.value = state.mapping[i] || opts[i];
        });

        $('#s_supabase_url').value = state.supaCreds.url || '';
        $('#s_supabase_key').value = state.supaCreds.key || '';
        $('#dlgSettings').showModal();
      }

      $('#dlgSettings').addEventListener('close', () => {
        if ($('#dlgSettings').returnValue === 'default') {
          state.settings.year = parseInt($('#s_year').value || '2025', 10);
          state.settings.icsDuration = parseInt($('#s_dur').value || '120', 10);
          state.settings.includeExported = $('#s_include_exported').value === 'true';
          state.mapping = [$('#map0').value, $('#map1').value, $('#map2').value, $('#map3').value, $('#map4').value];
          state.supaCreds = {
            url: ($('#s_supabase_url').value || '').trim(),
            key: ($('#s_supabase_key').value || '').trim()
          };
          savePrefs();
          if (state.supaCreds.url && state.supaCreds.key) initSupabase();
        }
      });

      $('#dlgEdit').addEventListener('close', async () => {
        const action = $('#dlgEdit').returnValue;
        if (action === 'cancel') return;

        if (action === 'delete' && state.editing) {
          await deleteEvent(state.editing.id);
          toast('Supprim√©');
          await refreshDay();
          return;
        }

        const rec = {
          ticket: $('#f_ticket').value.trim(),
          date: $('#f_date').value,
          start_time: $('#f_time').value,
          site: $('#f_site').value.trim(),
          type: $('#f_type').value.trim(),
          technicien: $('#f_technicien').value.trim(),
          hno: $('#f_hno').value === 'true',
          notes: $('#f_notes').value.trim()
        };

        const uidBase = `${rec.date}|${rec.ticket.toLowerCase()}|${rec.site.toLowerCase()}|${rec.technicien.toLowerCase()}|${rec.start_time}`;

        // SHA1 stable
        if (window.crypto?.subtle) {
          const enc = new TextEncoder().encode(uidBase);
          const buf = await crypto.subtle.digest('SHA-1', enc);
          rec.event_uid = Array.from(new Uint8Array(buf)).map((b) => b.toString(16).padStart(2,'0')).join('');
        } else {
          let h = 0; for (let i=0;i<uidBase.length;i++){ h=((h<<5)-h)+uidBase.charCodeAt(i); h|=0; }
          rec.event_uid = 'f' + (h>>>0).toString(16);
        }

        if (state.editing && state.editing.id) rec.id = state.editing.id;

        await upsertEvents([rec]);
        toast('Enregistr√©');
        await refreshDay();
      });

      // ===== Boot s√©curis√© =====
      try{
        loadPrefs();
        bindUI();
        $('#datePicker').value = state.currentDate;
        // Si Supabase non configur√©, on peut quand m√™me afficher UI (events resteront vides)
        // render apr√®s √©ventuellement refreshDay
        render();
        toast("Configure Supabase (si besoin), importe l‚ÄôExcel interventions. Planification via le bouton üìã");
      }catch(err){
        console.error('BOOT ERROR:', err);
        toast('Erreur au d√©marrage: ' + (err && err.message ? err.message : err));
      }

    } // fin startApp
  })();
  </script>

  <!--
  =======================
  Rappel SQL SUPABASE
  =======================

  create table if not exists public.events (
    id uuid primary key default gen_random_uuid(),
    event_uid text unique not null,
    date date not null,
    start_time time,
    ticket text,
    site text,
    type text,
    technicien text,
    hno boolean default false,
    notes text,
    exported_flag boolean default false,
    exported_at timestamptz,
    created_at timestamptz default now(),
    updated_at timestamptz default now()
  );

  create or replace function public.set_updated_at()
  returns trigger as $$ begin new.updated_at = now(); return new; end; $$ language plpgsql;
  drop trigger if exists trg_set_updated_at on public.events;
  create trigger trg_set_updated_at before update on public.events for each row execute function public.set_updated_at();

  alter table public.events enable row level security;
  create policy if not exists "events_read_all"   on public.events for select using (true);
  create policy if not exists "events_write_all"  on public.events for insert with check (true);
  create policy if not exists "events_update_all" on public.events for update using (true) with check (true);
  create policy if not exists "events_delete_all" on public.events for delete using (true);

  -- Activer Realtime sur la table events dans Supabase.
  -->
</body>
</html>
