<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agenda des interventions + Planification</title>
  <style>
    :root{ --bg:#0b0f14; --panel:#111823; --muted:#7a8aa1; --text:#e6edf6; --accent:#4cc2ff; --accent-2:#78e08f; --danger:#ff6b6b; --warn:#ffc048; --radius:16px }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0a0f14,#0d141d);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    header{position:sticky;top:0;z-index:10;background:rgba(10,15,20,.8);backdrop-filter:saturate(140%) blur(10px);border-bottom:1px solid #17202e}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .brand{display:flex;gap:10px;align-items:center}
    .brand h1{font-size:18px;margin:0;font-weight:700;letter-spacing:.2px}
    .brand .dot{width:12px;height:12px;border-radius:50%;background:radial-gradient(circle at 30% 30%, #8ee0ff, #4cc2ff)}
    .toolbar{display:grid;grid-template-columns:1fr auto;gap:12px;margin-top:12px}
    .filters{display:flex;flex-wrap:wrap;gap:8px}
    .filters > * {min-width:150px}
    .actions{display:flex;flex-wrap:wrap;gap:8px}
    button,select,input[type="date"],input[type="time"],input[type="text"],input[type="file"],.btn,textarea{
      background:#0f1622;color:var(--text);border:1px solid #1d2a3c;border-radius:12px;padding:10px 12px;outline:none
    }
    button:hover,.btn:hover{border-color:#2b3d57}
    button.primary{background:linear-gradient(180deg,#1b283c,#142035);border-color:#274160}
    button.ok{background:linear-gradient(180deg,#204231,#1a3527);border-color:#2d6444}
    button.warn{background:linear-gradient(180deg,#3e310d,#2b2109);border-color:#6b5017}
    button.danger{background:linear-gradient(180deg,#3d1515,#2a0e0e);border-color:#6a2323}
    main{max-width:1200px;margin:18px auto;padding:0 16px 80px}
    .cards{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:860px){.cards{grid-template-columns:1fr 1fr}}
    .card{background:linear-gradient(180deg,#0f1622,#0c121b);border:1px solid #1a2535;border-radius:var(--radius);padding:16px;box-shadow:0 4px 18px rgba(0,0,0,.25)}
    .card h2{margin:0 0 12px 0;font-size:16px}
    .pill{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:6px 10px;border:1px solid #203049;background:#0f1622;color:#bcd}
    .list{width:100%;border-collapse:separate;border-spacing:0 8px}
    .list th{font-weight:600;color:#9fbed6;text-align:left;padding:4px 8px}
    .list td{background:#0f1622;border:1px solid #1b2940;border-left:none;border-right:none;padding:10px 10px}
    .list tr{transition:transform .08s ease}
    .list tr:hover{transform:translateY(-1px)}
    .list .row{border-radius:10px;overflow:hidden}
    .list .row td:first-child{border-left:1px solid #1b2940;border-top-left-radius:10px;border-bottom-left-radius:10px}
    .list .row td:last-child{border-right:1px solid #1b2940;border-top-right-radius:10px;border-bottom-right-radius:10px}
    .muted{color:var(--muted)}
    .badge{padding:2px 8px;border-radius:999px;border:1px solid #274160;background:#0f1622;font-size:12px}
    .badge.infra{border-color:#305f44}
    .badge.rocade{border-color:#604a30}
    .badge.audit{border-color:#2e4f7a}
    .tag{font-size:11px;padding:2px 6px;border-radius:6px;border:1px solid #2b3d57;color:#a9c2db}
    .tag.hno{border-color:#6b3e3e;color:#ffbdbd}
    .flex{display:flex;gap:8px;align-items:center}
    .right{margin-left:auto}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    dialog{border:none;border-radius:18px;background:linear-gradient(180deg,#0e1520,#0a121a);color:var(--text);padding:0;max-width:840px;box-shadow:0 20px 60px rgba(0,0,0,.45)}
    dialog::backdrop{background:rgba(2,6,12,.6)}
    .modal-head{padding:16px 18px;border-bottom:1px solid #1a2535;display:flex;gap:8px;align-items:center}
    .modal-body{padding:18px}
    .modal-foot{padding:12px 18px;border-top:1px solid #1a2535;display:flex;gap:8px;justify-content:flex-end}
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-size:12px;color:#a9c2db}
    .hint{font-size:12px;color:#9cb1c9}
    .sep{height:1px;background:#162133;margin:10px 0}
    .typeahead{position:relative}
    .typeahead-list{position:absolute;left:0;right:0;top:calc(100% + 6px);background:#0f1622;border:1px solid #263652;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.35);max-height:220px;overflow:auto;z-index:50}
    .typeahead-item{padding:8px 10px;cursor:pointer}
    .typeahead-item:hover,.typeahead-item.active{background:#142033}
    .toast{position:fixed;right:14px;bottom:14px;background:#0f1622;color:#dfefff;border:1px solid #263652;border-radius:12px;padding:10px 12px;box-shadow:0 10px 30px rgba(0,0,0,.3)}
    .small{padding:6px 8px;border-radius:10px}
    /* planification list */
    .mini-list{display:flex;flex-direction:column;gap:8px;max-height:240px;overflow:auto;border:1px solid #203049;border-radius:12px;padding:8px;background:#0f1622}
    .mini-item{display:flex;gap:8px;align-items:center;justify-content:space-between;border:1px solid #1b2940;padding:8px;border-radius:10px}
    .pill-sel{display:inline-flex;gap:6px;align-items:center;border:1px solid #274160;border-radius:999px;padding:4px 8px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="brand"><span class="dot"></span><h1>Agenda des interventions</h1><span id="liveState" class="pill" title="√âtat de la connexion Realtime">Realtime : <strong id="liveLabel">off</strong></span><span class="muted" style="margin-left:auto">TZ locale</span></div>
      <div class="toolbar">
        <div class="filters">
          <input type="date" id="datePicker" />
          <select id="techFilter"><option value="">Tous techniciens</option></select>
          <select id="typeFilter"><option value="">Tous types</option></select>
          <input type="text" id="searchInput" placeholder="Rechercher (ticket / site / note)" />
        </div>
        <div class="actions">
          <label class="btn" for="excelInput">üì• Importer Excel</label>
          <input id="excelInput" type="file" accept=".xlsx,.xls" hidden />
          <button id="btnPlanif" class="primary">üó∫Ô∏è Planification</button>
          <button id="btnAdd" class="primary">+ Ajouter</button>
          <button id="btnExport">Exporter XLS</button>
          <button id="btnSettings">Param√®tres</button>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="cards">
      <section class="card">
        <h2 class="flex">Planning du <span id="dayLabel" class="badge">‚Äî</span><span class="right muted" id="countLabel"></span></h2>
        <table class="list" id="eventsTable">
          <thead>
            <tr>
              <th>Ticket</th>
              <th>Heure</th>
              <th>Site / Ville</th>
              <th>Type</th>
              <th>Technicien</th>
              <th>Infos</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="eventsBody"></tbody>
        </table>
      </section>

      <section class="card">
        <h2>Journal</h2>
        <div id="log" class="muted" style="white-space:pre-wrap"></div>
      </section>
    </div>
  </main>

  <!-- Modale Planification -->
  <dialog id="dlgPlanif">
    <form method="dialog">
      <div class="modal-head"><strong>Planification (d√©partement ‚Üí technicien ‚Üí ville ‚Üí type)</strong></div>
      <div class="modal-body">
        <div class="grid3">
          <div class="field">
            <label>D√©partement (2 chiffres)</label>
            <input type="text" id="p_dept" placeholder="ex. 13" maxlength="3" />
          </div>
          <div class="field">
            <label>&nbsp;</label>
            <button type="button" id="p_search" class="primary">Rechercher techniciens</button>
          </div>
          <div class="field">
            <label>Techniciens trouv√©s</label>
            <div id="p_found_count" class="pill" style="width:max-content">0</div>
          </div>
        </div>

        <div class="grid2" style="margin-top:10px">
          <div class="field">
            <label>Technicien</label>
            <select id="p_tech"></select>
          </div>
          <div class="field">
            <label>Ville</label>
            <input type="text" id="p_city" placeholder="Ville de l'intervention" />
          </div>
        </div>

        <div class="field" style="margin-top:10px">
          <label>Type d'intervention</label>
          <div class="grid3">
            <label class="pill-sel"><input type="radio" name="p_type" value="Audit site isol√©" checked> Audit site isol√©</label>
            <label class="pill-sel"><input type="radio" name="p_type" value="Audit site mitoyen"> Audit site mitoyen</label>
            <label class="pill-sel"><input type="radio" name="p_type" value="Travaux rocade"> Travaux rocade</label>
            <label class="pill-sel"><input type="radio" name="p_type" value="Travaux lien"> Travaux lien</label>
            <label class="pill-sel"><input type="radio" name="p_type" value="Travaux rocade et lien"> Travaux rocade et lien</label>
            <label class="pill-sel"><input type="radio" name="p_type" value="Autres"> Autres</label>
          </div>
        </div>

        <div class="grid3" style="margin-top:10px">
          <div class="field">
            <label>Note (optionnel)</label>
            <input type="text" id="p_note" placeholder="Ex. contraintes, acc√®s, HNO‚Ä¶" />
          </div>
          <div class="field">
            <label>&nbsp;</label>
            <button type="button" id="p_save" class="ok">Enregistrer</button>
          </div>
          <div class="field">
            <label>&nbsp;</label>
            <button type="button" id="p_clear_form">Effacer le formulaire</button>
          </div>
        </div>

        <div class="sep"></div>
        <div class="grid2">
          <div class="field">
            <label>Brouillon du technicien s√©lectionn√©</label>
            <div id="p_queue" class="mini-list"></div>
          </div>
          <div class="field">
            <label>Actions</label>
            <div class="flex" style="flex-wrap:wrap;gap:8px">
              <button type="button" id="p_export" class="primary">Exporter interventions (XLS)</button>
              <button type="button" id="p_flush" class="danger">Vider la liste</button>
            </div>
            <p class="hint" style="margin-top:8px">L'export contient : Ville, D√©partement, Technicien, Type, Note. Les dates/heures seront √† compl√©ter selon le planning du technicien.</p>
          </div>
        </div>
      </div>
      <div class="modal-foot">
        <button value="cancel">Fermer</button>
      </div>
    </form>
  </dialog>

  <!-- Modales d'origine (√âdition / Param√®tres / Mail / Export) -->
  <!-- === Copie int√©grale des dialogues d'origine non modifi√©s par souci de compacit√© === -->
  <!-- >>> Pour simplifier l'exemple, les bo√Ætes de dialogue initiales sont omises ici.
       Int√©grez ce fichier √† la place de votre HTML actuel, OU copiez/collez uniquement les ajouts
       (bouton üó∫Ô∏è Planification, <dialog id="dlgPlanif">, et le JS associ√©) dans votre fichier existant. -->

  <div id="toast" class="toast" style="display:none"></div>

  <!-- Dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

  <script>
    // ======= UTIL =======
    const $ = (s, root=document) => root.querySelector(s);
    const $$ = (s, root=document) => [...root.querySelectorAll(s)];
    const toast = (msg, ms=2500) => { const t=$('#toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none', ms) };
    const pad = n => String(n).padStart(2,'0');
    const normalize = s => String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/\s+/g,' ').trim();

    function downloadFile(name, mime, data){ const blob=new Blob([data],{type:mime}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 1000); }
    function s2ab(s){ const buf=new ArrayBuffer(s.length); const view=new Uint8Array(buf); for(let i=0;i<s.length;i++) view[i]=s.charCodeAt(i)&0xFF; return buf; }

    // ======= STATE (reprend l'essentiel + planification) =======
    const state = {
      techDirectory: JSON.parse(localStorage.getItem('agenda_tech_directory')||'[]'),
      planifQueue: JSON.parse(localStorage.getItem('planif_queue')||'{}'), // { techName: [ {dept, city, type, note, ts} ] }
    };

    // ======= Annuaire: support colonne ¬´Departements¬ª =======
    // Si votre import existant ne stocke pas encore departements, vous pouvez pousser
    // un tableau t.departements = ['13','84'] dans chaque entr√©e et le sauvegarder √† part :
    function setTechDirectory(dir){ state.techDirectory = dir; localStorage.setItem('agenda_tech_directory', JSON.stringify(dir)); }

    function saveQueue(){ localStorage.setItem('planif_queue', JSON.stringify(state.planifQueue)); }

    // ======= PLANIFICATION UI =======
    function openPlanif(){
      // reset compteur
      $('#p_found_count').textContent = '0';
      buildTechSelect([]);
      $('#p_city').value=''; $('#p_note').value='';
      $('#dlgPlanif').showModal();
    }

    function buildTechSelect(list){
      const sel = $('#p_tech'); sel.innerHTML='';
      if(!list || !list.length){ sel.innerHTML='<option value="">‚Äî</option>'; return; }
      list.forEach(t=>{
        const o=document.createElement('option');
        o.value=t.displayName; o.textContent=t.displayName + (t.ville? ' ¬∑ '+t.ville : '');
        sel.appendChild(o);
      });
      renderQueueFor(sel.value);
    }

    function searchTechsByDept(deptRaw){
      const d = (deptRaw||'').trim();
      if(!/^\d{2,3}$/.test(d)) { toast('D√©partement invalide'); return []; }
      // Chaque technicien doit avoir t.departements = ['13','84', ...]
      const list = (state.techDirectory||[]).filter(t=> Array.isArray(t.departements) && t.departements.some(x=> String(x).padStart(2,'0')===String(d).padStart(2,'0')));
      $('#p_found_count').textContent = String(list.length);
      return list.sort((a,b)=> (a.lastName||'').localeCompare(b.lastName||''));
    }

    function addPlanned(){
      const dept = $('#p_dept').value.trim();
      const tech = $('#p_tech').value.trim();
      const city = $('#p_city').value.trim();
      const type = (document.querySelector('input[name="p_type"]:checked')||{}).value || 'Autres';
      const note = $('#p_note').value.trim();
      if(!/^\d{2,3}$/.test(dept)) return toast('D√©partement invalide');
      if(!tech) return toast('Choisis un technicien');
      if(!city) return toast('Renseigne la ville');
      const rec = { dept: dept.padStart(2,'0'), city, type, note, tech, ts: Date.now() };

      if(!state.planifQueue[tech]) state.planifQueue[tech]=[];
      state.planifQueue[tech].push(rec); saveQueue();
      toast('Ajout√© au brouillon');
      renderQueueFor(tech);
      // on vide juste ville/note pour encha√Æner
      $('#p_city').value=''; $('#p_note').value=''; $('#p_city').focus();
    }

    function renderQueueFor(tech){
      const cont = $('#p_queue'); cont.innerHTML='';
      const arr = state.planifQueue[tech]||[];
      if(!arr.length){ cont.innerHTML = '<div class="muted">Aucune intervention en brouillon pour ce technicien.</div>'; return; }
      arr.forEach((r,idx)=>{
        const el=document.createElement('div'); el.className='mini-item';
        el.innerHTML = `<div><strong>${r.city}</strong> (dep ${r.dept}) ‚Ä¢ <span class="muted">${r.type}</span>${r.note? ' ‚Äî '+r.note:''}</div>
                        <div class="flex"><button data-i="${idx}" class="small" data-act="del">üóëÔ∏è</button></div>`;
        cont.appendChild(el);
      });
      cont.addEventListener('click', (e)=>{
        const b=e.target.closest('button'); if(!b) return; const i=+b.getAttribute('data-i');
        if(b.getAttribute('data-act')==='del'){ state.planifQueue[tech].splice(i,1); saveQueue(); renderQueueFor(tech); }
      }, { once:true });
    }

    function exportForTech(tech){
      const arr = state.planifQueue[tech]||[]; if(!arr.length) return toast('Rien √† exporter');
      const rows = arr.map(r=> ({ Ville:r.city, Departement:r.dept, Technicien:r.tech, Type:r.type, Note:r.note }));
      const ws = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Planif');
      const bin = XLSX.write(wb, {bookType:'xlsx', type:'binary'});
      downloadFile(`planif_${normalize(tech).replace(/\s+/g,'_')}.xlsx`, 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', s2ab(bin));
    }

    // Sauvegarde dans Firebase si dispo, sinon localStorage (d√©j√† fait via queue)
    async function persistOne(rec){
      try{
        const fb = window.firebase; // suppos√© d√©j√† charg√© dans votre contexte
        if(fb?.apps?.length && fb.firestore){
          const db = fb.firestore();
          await db.collection('planification').add({
            technicien: rec.tech,
            departement: rec.dept,
            ville: rec.city,
            type: rec.type,
            note: rec.note || '',
            created_at: new Date(rec.ts || Date.now())
          });
          toast('Enregistr√© dans Firebase');
        } else {
          // Fallback: d√©j√† conserv√© dans planifQueue (localStorage)
          toast('Enregistr√© (local) ‚Äî Firebase non d√©tect√©');
        }
      }catch(e){ console.error(e); toast('Erreur enregistrement'); }
    }

    // ======= HOOKS =======
    $('#btnPlanif')?.addEventListener('click', openPlanif);
    $('#p_search')?.addEventListener('click', ()=>{ const lst=searchTechsByDept($('#p_dept').value); buildTechSelect(lst); });
    $('#p_tech')?.addEventListener('change', e=> renderQueueFor(e.target.value));
    $('#p_save')?.addEventListener('click', async ()=>{ const tech=$('#p_tech').value; addPlanned(); const arr=state.planifQueue[tech]; if(arr && arr.length) await persistOne(arr[arr.length-1]); });
    $('#p_export')?.addEventListener('click', ()=>{ const tech=$('#p_tech').value; if(!tech) return toast('Choisis un technicien'); exportForTech(tech); });
    $('#p_flush')?.addEventListener('click', ()=>{ const tech=$('#p_tech').value; if(!tech) return toast('Choisis un technicien'); state.planifQueue[tech]=[]; saveQueue(); renderQueueFor(tech); toast('Liste vid√©e'); });
    $('#p_clear_form')?.addEventListener('click', ()=>{ $('#p_city').value=''; $('#p_note').value=''; $('#p_city').focus(); });

    // ======= Exemple d'extension d'import annuaire pour ajouter ¬´Departements¬ª =======
    // Si vous avez d√©j√† une fonction importTechExcel ailleurs, ajoutez-y quelque chose comme :
    // map.depts = find(['departements','d√©partements','dept','depts','secteur','secteurs']);
    // const depts = String(r[map.depts]||'').replace(/[^0-9,; ]/g,'').split(/[;,\s]+/).filter(Boolean).map(x=>x.padStart(2,'0'));
    // out.push({ ... , departements: depts })

    // Boot minimal (journal)
    (function boot(){ toast('Planification pr√™te : bouton üó∫Ô∏è en haut √† droite'); })();
  </script>
</body>
</html>
